---
import {getCollection} from 'astro:content';

// Get all content
const intro = await getCollection('sections').then(entries =>
    entries.find(entry => entry.id === 'intro.md')
);
const timeline = await getCollection('sections').then(entries =>
    entries.find(entry => entry.id === 'timeline.md')
);

// Load curtain images
const curtainImagesGlob = import.meta.glob('/src/assets/images/curtain/*.{jpg,jpeg,png,webp,gif}', {
    eager: true,
    import: 'default'
});
const curtainImagePaths = Object.entries(curtainImagesGlob).map(([path, module]) => {
    // @ts-ignore - module is the imported image object with src property
    return module.src;
});

// Shuffle function
function shuffleArray(array) {
    const arr = [...array];
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

const shuffledImages = shuffleArray(curtainImagePaths);

// Render markdown content
const {Content: IntroContent} = intro ? await intro.render() : {Content: null};
const {Content: TimelineContent} = timeline ? await timeline.render() : {Content: null};

// Generate random favicon number
const rand = Math.floor(Math.random() * 6);
---

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
        <meta name="description"
              content="Bremen-based graphic designer and programmer, with a focus on experimental web development."/>
        <meta name="author" content="David Wahrenburg"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <link rel="stylesheet" href={`${import.meta.env.BASE_URL}css/style.css`}/>
        <link rel="shortcut icon" href={`${import.meta.env.BASE_URL}images/favicon_${rand}.png`} type="image/x-icon"/>
        <title>David Wahrenburg</title>

        <script define:vars={{shuffledImages}}>
            // Curtain images array for client-side swapping (global scope)
            window.curtainImagesArray = shuffledImages;
            window.currentIndex = 2; // Start at index 2 (first two images already displayed)

            // Random link colors - each link gets a different color
            const linkColors = [
                '#d20000', // red
                '#00b475', // turquoise
                '#0066ff', // blue
                '#f64900', // light salmon
                '#b99a00', // yellow
                '#8816b4', // purple
                '#cc7b00', // peach
                '#903caf'  // lavender
            ];

            // Apply random colors to each link on page load


            // Helper function to extract filename from path
            window.getFilenameFromPath = (path) => {
                const parts = path.split('/');
                const filenameWithHash = parts[parts.length - 1];
                // Remove hash and extension for cleaner display
                const filename = filenameWithHash.split('.')[0];
                return filename + ".jpg";
            };

            let changeColors = () => {
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                    link.style.color = linkColors[Math.floor(Math.random() * linkColors.length)];
                });
                const textCOntainer = document.getElementById('text-container');
                textCOntainer.style.borderColor = linkColors[Math.floor(Math.random() * linkColors.length)];
            }
            document.addEventListener('DOMContentLoaded', () => {
                changeColors();

                // Set initial filenames
                const leftImg = document.getElementById('curtain-img-left');
                const rightImg = document.getElementById('curtain-img-right');
                const leftFilename = document.getElementById('filename-left');
                const rightFilename = document.getElementById('filename-right');

                if (leftImg && leftFilename) {
                    leftFilename.textContent = window.getFilenameFromPath(leftImg.src);
                }
                if (rightImg && rightFilename) {
                    rightFilename.textContent = window.getFilenameFromPath(rightImg.src);
                }
            });

            // Matomo Analytics
            var _paq = window._paq = window._paq || [];
            _paq.push(['trackPageView']);
            _paq.push(['enableLinkTracking']);
            (function () {
                var u = "//webstat.davidwahrenburg.de/";
                _paq.push(['setTrackerUrl', u + 'matomo.php']);
                _paq.push(['setSiteId', '1']);
                var d = document,
                    g = d.createElement('script'),
                    s = d.getElementsByTagName('script')[0];
                g.async = true;
                g.src = u + 'matomo.js';
                s.parentNode.insertBefore(g, s);
            })();
        </script>
    </head>

    <body>
        <div id="text-container">
            <div class="level-0 intro-content">
                {IntroContent &&
                        <IntroContent/>}
            </div>

            <!--<div class="projects-container">
                <p class="level-0">Selected Projects:</p>
                {projects.map((project) => {
                    const hasImages = project.data.hasImages && project.data.showImages;
                    const hasLink = project.data.url && project.data.url !== "";

                    return (
                            <>
                            <p
                                    class:list={[
                                        "level-1",
                                        {"has-images": hasImages},
                                        {"has-link": hasLink}
                                    ]}
                                    id={project.slug}
                            >
                                {project.data.title}
                                {hasImages && <span>‚ñ†</span>}
                                {hasLink && (
                                        <a href={`https://${project.data.url}`} target="_blank">
                                            ‚Üó
                                        </a>
                                )}
                            </p>
                            <p class="level-2">
                                (<i>{project.data.tags.length > 0 && `${project.data.tags.join(', ')}, `}</i>{project.data.year})
                            </p>
                            </>
                    );
                })}
            </div>-->

            <!--         <br/>
                     <p class="level-1">‚ñ†&nbsp;images <span class="mobile-only">available in desktop view</span></p>
                     <p class="level-1">‚Üó&nbsp;hyperlink</p>
                     <br/>-->

            <!--         <div class="timeline-container">
                         <p class="level-0">Timeline:</p>
                         <div class="level-1 timeline-content">
                             {TimelineContent &&
                                     <TimelineContent/>}
                         </div>
                     </div>-->
            <br/>
            <div id="impressum-btn" class="level-0">Imprint</div>
            <div class="imprint-container level-0">
                <br/>
                Responsible for shown content, design and development of this website:<br/>
                David Wahrenburg<br/>
                Weizenkampstra√üe 189<br/>
                D-28199 Bremen<br/>
                ¬©{new Date().getFullYear()} all rights
                reserved
                <br/><br/>
                Free Palestine! üçâ
            </div>
        </div>

        <div id="grid"></div>

        <div id="image-container">
            {shuffledImages.length >= 2 && (
                    <>
                    <div class="curtain-column" data-column="left">
                        <img id="curtain-img-left" src={shuffledImages[0]} alt=""/>
                        <div class="image-filename" id="filename-left"></div>
                    </div>
                    <div class="curtain-column" data-column="right">
                        <img id="curtain-img-right" src={shuffledImages[1]} alt=""/>
                        <div class="image-filename" id="filename-right"></div>
                    </div>
                    </>
            )}
        </div>

        <script is:inline src={`${import.meta.env.BASE_URL}js/script.js`}></script>
    </body>
</html>
